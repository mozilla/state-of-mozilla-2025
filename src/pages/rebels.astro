---
import { Image, getImage } from "astro:assets";
import Layout from "../layouts/Layout.astro";
// import Captcha from "../components/Captcha.svelte";
import Svg from "../components/Svg.svelte";
// import ProgressWatcher from "../components/ProgressWatcher.svelte";
import City from "../components/City.svelte";
import { rebels } from "../data/rebels.js";
import dotsBig from "../assets/img/dots-big.png";

// Dynamically import all images from assets/img (non-eager for selective loading)
const images = import.meta.glob<{ default: ImageMetadata }>(
  "../assets/img/*.{jpg,jpeg,png,gif,webp}",
);

// Build a map of filename -> optimized URL for images used in rebels data
const rebelImages: Record<string, string> = {};
for (const rebel of rebels) {
  const imagePath = `../assets/img/${rebel.image}`;
  if (images[imagePath]) {
    const module = await images[imagePath]();
    const optimized = await getImage({ src: module.default });
    rebelImages[rebel.image] = optimized.src;
  }
}
---

<Layout>
  <!-- <Captcha client:load /> -->

  <section
    class="mb-0 relative p-2.5 lg:p-5 min-h-[50vh] bg-yellow overflow-hidden"
  >
    <Image
      priority
      class="absolute bottom-0 left-0 right-0 lg:translate-y-1/2"
      src={dotsBig}
      alt=""
    />
    <div
      class="absolute w-1/2 lg:w-1/4 right-2.5 lg:right-5 bottom-2.5 lg:bottom-5"
    >
      <Svg client:load src="/svg/icon-rebels.svg" class="w-full h-full" />
    </div>
    <div class="relative lg:w-3/4 space-y-2.5 lg:space-y-5">
      <h1 class="font-computer uppercase text-6xl lg:text-8xl">
        Building collective power
      </h1>
    </div>
  </section>

  <City client:load rebelImages={rebelImages} />

  <section class="px-2.5 lg:px-5">
    <div class="grid lg:grid-cols-3 lg:gap-2.5">
      <div class="lg:col-start-2">
        <a
          class="group flex flex-col gap-px bg-yellow text-black hover:bg-black hover:text-white outline outline-dashed outline-black divide-y divide-dashed"
          href="/roadmap"
        >
          <div>
            <div class="p-2.5 p-5 space-y-2.5">
              <p class="uppercase">Go to final chapter</p>
              <h3
                class="text-5xl lg:text-xl xl:text-2xl 2xl:text-3xl uppercase"
              >
                Roadmap
              </h3>
            </div>
            <div class="relative overflow-hidden h-10 lg:h-20 -mt-10">
              <Svg
                client:load
                src="/svg/dots.svg"
                class="absolute left-0 right-0 top-1/2 -translate-y-1/2 w-full object-cover"
              />
            </div>
          </div>
          <div class="p-2.5">PROCEED â†’</div>
        </a>
      </div>
    </div>
  </section>

  <!-- <ProgressWatcher
    client:load
    current="rebels"
    number="five"
    n="5"
    position="fifth"
    next="roadmap"
    text="> Find all the rebels to unlock stamp..."
  /> -->
</Layout>
